services:
  # =============================================================================
  # BLOCKCHAIN - Local Ethereum via Anvil (Foundry)
  # =============================================================================
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: anvil
    command: --host 0.0.0.0 --port 8545 --block-time 1 --accounts 20 --balance 10000 --chain-id 31337
    ports:
      - "${ANVIL_PORT:-8545}:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Contract deployment after Anvil is ready
  contract-deployer:
    build: ./simulator/blockchain
    depends_on:
      anvil:
        condition: service_healthy
    environment:
      RPC_URL: http://anvil:8545
      PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
    volumes:
      - contract_artifacts:/app/artifacts

  # =============================================================================
  # DATABASE - PostgreSQL for persistent state
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: simulator
      POSTGRES_USER: simulator
      POSTGRES_PASSWORD: simulator
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./simulator/database/init.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./simulator/database/seeds:/docker-entrypoint-initdb.d/seeds
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U simulator -d simulator"]
      interval: 5s
      timeout: 5s
      retries: 10

  # =============================================================================
  # CACHE - Redis for sessions and real-time
  # =============================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10

  # =============================================================================
  # BACKEND - Cloudflare Workers via Wrangler Local
  # =============================================================================
  backend:
    build:
      context: .
      dockerfile: ./simulator/backend/Dockerfile
    environment:
      ENVIRONMENT: simulator
      ETHEREUM_SEPOLIA_RPC: http://anvil:8545
      DATABASE_URL: postgres://simulator:simulator@postgres:5432/simulator
      REDIS_URL: redis://redis:6379
      USSD_SERVICE_URL: http://ussd-sim:4000
      TELEGRAM_SERVICE_URL: http://telegram-mock:4001
      FCM_SERVICE_URL: http://fcm-mock:4002
      CONTRACT_IDENTITY_ADDRESS: "0x3Aa5ebB10DC797CAC828524e59A333d0A371443c"
      ESCROW_CONTRACT_ADDRESS: "0xc6e7DF5E7b4f2A278906862b61205850344D4e7d"
      DAI_CONTRACT_ADDRESS: "0x68B1D87F95878fE05B998F19b66F4baba5De1aed"
      PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      contract-deployer:
        condition: service_completed_successfully
    volumes:
      - contract_artifacts:/app/contract_artifacts:ro

  # =============================================================================
  # MOCK SERVICES
  # =============================================================================
  
  # USSD Simulator - Virtual Telecom Network
  ussd-sim:
    build: ./simulator/services/ussd-sim
    environment:
      DATABASE_URL: postgres://simulator:simulator@postgres:5432/simulator
      SIM_CONTROL_URL: http://sim-control:4003
    ports:
      - "${USSD_SIM_PORT:-4000}:4000"
    depends_on:
      - postgres
      - sim-control

  sim-control:
    build: ./simulator/services/sim-control
    environment:
      RPC_URL: http://anvil:8545
      DATABASE_URL: postgres://simulator:simulator@postgres:5432/simulator
    volumes:
      - ./simulator/scenarios:/app/scenarios
    ports:
      - "${SIM_CONTROL_PORT:-4003}:4003"
    depends_on:
      - anvil
      - postgres

  # Mock Telegram Bot Server
  telegram-mock:
    build: ./simulator/services/telegram-mock
    environment:
      PORT: 4001
      DATABASE_URL: postgres://simulator:simulator@postgres:5432/simulator
    ports:
      - "${TELEGRAM_MOCK_PORT:-4001}:4001"
    depends_on:
      postgres:
        condition: service_healthy

  # Mock FCM Push Notification Service
  fcm-mock:
    build: ./simulator/services/fcm-mock
    environment:
      PORT: 4002
      REDIS_URL: redis://redis:6379
    ports:
      - "${FCM_MOCK_PORT:-4002}:4002"
    depends_on:
      redis:
        condition: service_healthy

  # =============================================================================
  # WEB DASHBOARD - Flutter Web Control Panel
  # =============================================================================
  dashboard:
    build:
      context: ./simulator/dashboard
      dockerfile: Dockerfile
    ports:
      - "${DASHBOARD_PORT}:5173"
    depends_on:
      - backend
      - sim-control

volumes:
  postgres_data:
  contract_artifacts:

networks:
  default:
    name: iamkey-simulator
